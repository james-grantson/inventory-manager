<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product - Stock Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #27ae60;
            z-index: 10;
        }
        .input-with-symbol {
            position: relative;
        }
        .input-with-symbol input {
            padding-left: 35px;
        }
        .category-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
        }
        .category-card.selected {
            border: 2px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        /* Styles for optional fields */
        .optional-field {
            border-left: 3px solid #ffc107;
            padding-left: 10px;
        }
        
        .profit-preview {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid #28a745;
        }
        
        .profit-value {
            font-weight: bold;
            color: #28a745;
        }
        
        .cost-currency {
            color: #6c757d;
        }
        
        /* Current values display */
        .current-value {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 5px;
            font-size: 0.9em;
            border-left: 3px solid #007bff;
        }
        
        /* Field changed indicator */
        .field-changed {
            background-color: #fff3cd;
            border-color: #ffeaa7 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <i class="fas fa-arrow-left me-2"></i>
                <div>
                    <strong>Edit Product</strong>
                    <small class="d-block text-light" style="font-size: 0.8rem; opacity: 0.9;">Update product details</small>
                </div>
            </a>
            <div class="navbar-text">
                <a href="index.html" class="btn btn-light btn-sm">
                    <i class="fas fa-home me-1"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Loading State -->
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading product data...</p>
                </div>

                <!-- Error State -->
                <div id="errorMessage" class="alert alert-danger" style="display: none;">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h5 class="alert-heading">Error Loading Product</h5>
                            <p id="errorDetails" class="mb-0">There was a problem loading the product data.</p>
                            <button class="btn btn-outline-danger btn-sm mt-2" onclick="loadProductData()">
                                <i class="fas fa-redo me-1"></i> Try Again
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification -->
                <div id="notification" class="alert" style="display: none;"></div>

                <!-- Form Card -->
                <div id="formContainer" style="display: none;">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2 text-primary"></i>
                                Edit Product Details
                            </h5>
                            <p class="text-muted mb-0 small">Update the product details below. Only fill fields you want to change.</p>
                            <div class="current-value mt-2">
                                <i class="fas fa-info-circle me-1 text-primary"></i>
                                Product ID: <span id="currentProductId" class="fw-semibold"></span>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="productForm">
                                <!-- Hidden field for product ID -->
                                <input type="hidden" id="productId" name="productId">
                                
                                <!-- Product Name -->
                                <div class="mb-4">
                                    <label for="productName" class="form-label fw-semibold">
                                        <i class="fas fa-tag me-1"></i> Product Name
                                    </label>
                                    <input type="text" class="form-control form-control-lg" 
                                           id="productName" 
                                           placeholder="e.g., Engine Oil 5W-30, Cement, Brake Pads">
                                    <div class="form-text">Leave empty if you don't want to change the name</div>
                                    <div class="current-value">
                                        Current: <span id="currentName" class="fw-semibold"></span>
                                    </div>
                                </div>

                                <!-- SKU (Optional) -->
                                <div class="mb-4 optional-field">
                                    <label for="productSKU" class="form-label fw-semibold">
                                        <i class="fas fa-barcode me-1"></i> SKU
                                    </label>
                                    <input type="text" class="form-control" 
                                           id="productSKU" 
                                           placeholder="e.g., OIL-5W30-001, BP-TOYOTA-2023">
                                    <div class="form-text">Leave empty to keep current SKU or clear it</div>
                                    <div class="current-value">
                                        Current: <span id="currentSKU" class="fw-semibold"></span>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-4 optional-field">
                                    <label for="productDescription" class="form-label fw-semibold">
                                        <i class="fas fa-align-left me-1"></i> Description
                                    </label>
                                    <textarea class="form-control" 
                                              id="productDescription" 
                                              rows="2"
                                              placeholder="Product details, specifications, or notes"></textarea>
                                    <div class="form-text">Leave empty to keep current description</div>
                                    <div class="current-value">
                                        Current: <span id="currentDescription" class="fw-semibold"></span>
                                    </div>
                                </div>

                                <!-- Category Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-tags me-1"></i> Category
                                    </label>
                                    <div class="row g-3" id="categorySelection">
                                        <div class="col-md-6">
                                            <div class="card category-card" data-category="Automobile Lubricants" onclick="selectCategory('Automobile Lubricants')">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-oil-can fa-2x text-primary mb-2"></i>
                                                    <h6 class="card-title mb-1">Automobile Lubricants</h6>
                                                    <small class="text-muted">Engine oil, grease, etc.</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card category-card" data-category="Automobile Parts" onclick="selectCategory('Automobile Parts')">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-cog fa-2x text-warning mb-2"></i>
                                                    <h6 class="card-title mb-1">Automobile Parts</h6>
                                                    <small class="text-muted">Spare parts, accessories</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card category-card" data-category="Building Materials" onclick="selectCategory('Building Materials')">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-hammer fa-2x text-danger mb-2"></i>
                                                    <h6 class="card-title mb-1">Building Materials</h6>
                                                    <small class="text-muted">Cement, rods, etc.</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card category-card" data-category="Other" onclick="selectCategory('Other')">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-box fa-2x text-secondary mb-2"></i>
                                                    <h6 class="card-title mb-1">Other</h6>
                                                    <small class="text-muted">Other products</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="current-value mt-2">
                                        Current Category: <span id="currentCategory" class="fw-semibold"></span>
                                    </div>
                                </div>

                                <!-- Price and Cost in one row -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="productPrice" class="form-label fw-semibold">
                                            <i class="fas fa-money-bill-wave me-1"></i> Selling Price ()
                                        </label>
                                        <div class="input-with-symbol">
                                            <span class="currency-symbol"></span>
                                            <input type="number" step="0.01" min="0" 
                                                   class="form-control" 
                                                   id="productPrice" 
                                                   placeholder="0.00"
                                                   oninput="calculateProfit()">
                                        </div>
                                        <div class="current-value">
                                            Current: <span id="currentPrice" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 optional-field">
                                        <label for="productCost" class="form-label fw-semibold">
                                            <i class="fas fa-money-bill me-1 cost-currency"></i> Cost Price ()
                                        </label>
                                        <div class="input-with-symbol">
                                            <span class="currency-symbol cost-currency"></span>
                                            <input type="number" step="0.01" min="0" 
                                                   class="form-control" 
                                                   id="productCost" 
                                                   placeholder="0.00"
                                                   oninput="calculateProfit()">
                                        </div>
                                        <div class="current-value">
                                            Current: <span id="currentCost" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quantity and Min Stock in one row -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="productQuantity" class="form-label fw-semibold">
                                            <i class="fas fa-boxes me-1"></i> Quantity
                                        </label>
                                        <input type="number" min="0" 
                                               class="form-control" 
                                               id="productQuantity" 
                                               placeholder="0"
                                               oninput="calculateProfit()">
                                        <div class="current-value">
                                            Current: <span id="currentQuantity" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 optional-field">
                                        <label for="productMinStock" class="form-label fw-semibold">
                                            <i class="fas fa-exclamation-triangle me-1"></i> Minimum Stock
                                        </label>
                                        <input type="number" min="1" 
                                               class="form-control" 
                                               id="productMinStock" 
                                               placeholder="10">
                                        <div class="current-value">
                                            Current: <span id="currentMinStock" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Supplier and Location in one row -->
                                <div class="row mb-4">
                                    <div class="col-md-6 optional-field">
                                        <label for="productSupplier" class="form-label fw-semibold">
                                            <i class="fas fa-truck me-1"></i> Supplier
                                        </label>
                                        <input type="text" class="form-control" 
                                               id="productSupplier" 
                                               placeholder="e.g., Shell Ghana Ltd, Kumasi Trading">
                                        <div class="current-value">
                                            Current: <span id="currentSupplier" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 optional-field">
                                        <label for="productLocation" class="form-label fw-semibold">
                                            <i class="fas fa-map-marker-alt me-1"></i> Location
                                        </label>
                                        <input type="text" class="form-control" 
                                               id="productLocation" 
                                               placeholder="e.g., Shelf A3, Warehouse 2, Store Room">
                                        <div class="current-value">
                                            Current: <span id="currentLocation" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Profit Summary -->
                                <div class="profit-preview mb-4">
                                    <h6 class="mb-2">
                                        <i class="fas fa-chart-line me-2"></i> Current Profit Summary
                                    </h6>
                                    <div class="row small">
                                        <div class="col-4">
                                            <div>Profit per Item:</div>
                                            <div class="profit-value" id="currentProfitPerItem">0.00</div>
                                        </div>
                                        <div class="col-4">
                                            <div>Profit Margin:</div>
                                            <div class="profit-value" id="currentProfitMargin">0%</div>
                                        </div>
                                        <div class="col-4">
                                            <div>Total Profit:</div>
                                            <div class="profit-value" id="currentTotalProfit">0.00</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Updated Profit Preview (Dynamic) -->
                                <div class="profit-preview" id="profitPreview" style="display: none;">
                                    <h6 class="mb-2">
                                        <i class="fas fa-chart-line me-2 text-primary"></i> Updated Profit Preview
                                    </h6>
                                    <div class="row small">
                                        <div class="col-4">
                                            <div>New Profit per Item:</div>
                                            <div class="profit-value" id="profitPerItem">0.00</div>
                                        </div>
                                        <div class="col-4">
                                            <div>New Profit Margin:</div>
                                            <div class="profit-value" id="profitMargin">0%</div>
                                        </div>
                                        <div class="col-4">
                                            <div>New Total Profit:</div>
                                            <div class="profit-value" id="totalProfit">0.00</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                    <a href="index.html" class="btn btn-outline-secondary me-md-2">
                                        <i class="fas fa-times me-1"></i> Cancel
                                    </a>
                                    <button type="button" class="btn btn-danger me-md-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-1"></i> Reset Changes
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-lg px-4" id="submitBtn">
                                        <i class="fas fa-save me-1"></i> Update Product
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Tips -->
                    <div class="card border-0 shadow-sm mt-4">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="fas fa-lightbulb me-2 text-warning"></i> Editing Tips
                            </h6>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small>Only fill fields you want to update - partial updates are supported</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small>Profit is automatically recalculated when you change price, cost, or quantity</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small>Click on a category card to change the category</small>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small>Use "Reset Changes" to clear all entered values</small>
                                </li>
                                <li>
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small>All fields are optional - only changed fields will be updated</small>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentProductData = {};
        let originalProductData = {};

        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Load product data
        async function loadProductData() {
            const productId = getUrlParameter('id');
            
            if (!productId) {
                showError('No product ID specified in URL');
                return;
            }
            
            try {
                showLoading(true);
                hideError();
                hideForm();
                
                const response = await fetch(`/api/products/${productId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Product not found');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const product = await response.json();
                currentProductData = product;
                originalProductData = JSON.parse(JSON.stringify(product));
                
                populateForm(product);
                updateCurrentProfit(product);
                showForm();
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading product:', error);
                showError(`Failed to load product: ${error.message}`);
                showLoading(false);
            }
        }

        // Populate form with current data
        function populateForm(product) {
            // Set product ID
            document.getElementById('productId').value = product.id;
            document.getElementById('currentProductId').textContent = product.id;
            
            // Current values
            document.getElementById('currentName').textContent = product.name || 'Not set';
            document.getElementById('currentSKU').textContent = product.sku || 'Not set';
            document.getElementById('currentDescription').textContent = product.description || 'Not set';
            document.getElementById('currentCategory').textContent = product.category || 'Not set';
            document.getElementById('currentPrice').textContent = formatPrice(product.price || 0);
            document.getElementById('currentCost').textContent = product.cost ? formatPrice(product.cost) : 'Not set';
            document.getElementById('currentQuantity').textContent = product.quantity || 0;
            document.getElementById('currentMinStock').textContent = product.minStock || 10;
            document.getElementById('currentSupplier').textContent = product.supplier || 'Not set';
            document.getElementById('currentLocation').textContent = product.location || 'Not set';
            
            // Select current category
            if (product.category) {
                selectCategory(product.category, false);
            }
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('en-GH', {
                style: 'currency',
                currency: 'GHS',
                minimumFractionDigits: 2
            }).format(price);
        }

        // Category selection
        function selectCategory(category, showNotification = true) {
            // Remove selected class from all cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            const card = document.querySelector(`.category-card[data-category="${category}"]`);
            if (card) {
                card.classList.add('selected');
            }
            
            if (showNotification) {
                showNotificationMessage(`Selected: ${category}`, 'info');
            }
        }

        // Calculate profit preview
        function calculateProfit() {
            const price = parseFloat(document.getElementById('productPrice').value) || currentProductData.price || 0;
            const cost = parseFloat(document.getElementById('productCost').value) || currentProductData.cost || 0;
            const quantity = parseInt(document.getElementById('productQuantity').value) || currentProductData.quantity || 0;
            
            if (cost > 0 && price > 0) {
                const profitPerItem = price - cost;
                const profitMargin = cost > 0 ? ((profitPerItem / cost) * 100) : 0;
                const totalProfit = profitPerItem * quantity;
                
                document.getElementById('profitPerItem').textContent = `${profitPerItem.toFixed(2)}`;
                document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
                document.getElementById('totalProfit').textContent = `${totalProfit.toFixed(2)}`;
                
                // Color code based on profit margin
                const marginElement = document.getElementById('profitMargin');
                if (profitMargin > 30) {
                    marginElement.className = 'profit-value text-success';
                } else if (profitMargin > 10) {
                    marginElement.className = 'profit-value text-warning';
                } else {
                    marginElement.className = 'profit-value text-danger';
                }
                
                document.getElementById('profitPreview').style.display = 'block';
            } else {
                document.getElementById('profitPreview').style.display = 'none';
            }
        }

        // Update current profit display
        function updateCurrentProfit(product) {
            const price = product.price || 0;
            const cost = product.cost || 0;
            const quantity = product.quantity || 0;
            
            if (cost > 0 && price > 0) {
                const profitPerItem = price - cost;
                const profitMargin = cost > 0 ? ((profitPerItem / cost) * 100) : 0;
                const totalProfit = profitPerItem * quantity;
                
                document.getElementById('currentProfitPerItem').textContent = `${profitPerItem.toFixed(2)}`;
                document.getElementById('currentProfitMargin').textContent = `${profitMargin.toFixed(1)}%`;
                document.getElementById('currentTotalProfit').textContent = `${totalProfit.toFixed(2)}`;
                
                // Color code based on profit margin
                const marginElement = document.getElementById('currentProfitMargin');
                if (profitMargin > 30) {
                    marginElement.className = 'profit-value text-success';
                } else if (profitMargin > 10) {
                    marginElement.className = 'profit-value text-warning';
                } else {
                    marginElement.className = 'profit-value text-danger';
                }
            }
        }

        // Show notification
        function showNotificationMessage(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Show loading state
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show form
        function showForm() {
            document.getElementById('formContainer').style.display = 'block';
        }

        // Hide form
        function hideForm() {
            document.getElementById('formContainer').style.display = 'none';
        }

        // Show error
        function showError(message) {
            document.getElementById('errorDetails').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Reset form to original values
        function resetForm() {
            // Clear all input fields
            document.getElementById('productName').value = '';
            document.getElementById('productSKU').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('productMinStock').value = '';
            document.getElementById('productSupplier').value = '';
            document.getElementById('productLocation').value = '';
            
            // Reset category selection
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Hide profit preview
            document.getElementById('profitPreview').style.display = 'none';
            
            showNotificationMessage('All changes have been reset', 'info');
        }

        // Handle form submission for partial update
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const updateData = {};
            
            // Collect only fields that have been changed (non-empty)
            const fields = [
                { id: 'productName', name: 'name' },
                { id: 'productSKU', name: 'sku' },
                { id: 'productDescription', name: 'description' },
                { id: 'productPrice', name: 'price', type: 'number' },
                { id: 'productCost', name: 'cost', type: 'number' },
                { id: 'productQuantity', name: 'quantity', type: 'number' },
                { id: 'productMinStock', name: 'minStock', type: 'number' },
                { id: 'productSupplier', name: 'supplier' },
                { id: 'productLocation', name: 'location' }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.value.trim();
                
                if (value !== '') {
                    if (field.type === 'number') {
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            updateData[field.name] = numValue;
                        }
                    } else {
                        updateData[field.name] = value;
                    }
                }
            });
            
            // Handle category (from selected card)
            const selectedCategoryCard = document.querySelector('.category-card.selected');
            if (selectedCategoryCard) {
                const selectedCategory = selectedCategoryCard.getAttribute('data-category');
                if (selectedCategory !== currentProductData.category) {
                    updateData.category = selectedCategory;
                }
            }
            
            // Validate update data
            if (Object.keys(updateData).length === 0) {
                showNotificationMessage('No changes detected. Please make changes before updating.', 'warning');
                return;
            }
            
            // Validate numeric fields
            if (updateData.price !== undefined && (isNaN(updateData.price) || updateData.price <= 0)) {
                showNotificationMessage('Please enter a valid selling price', 'danger');
                return;
            }
            
            if (updateData.cost !== undefined && (isNaN(updateData.cost) || updateData.cost < 0)) {
                showNotificationMessage('Please enter a valid cost price or leave empty', 'danger');
                return;
            }
            
            if (updateData.quantity !== undefined && (isNaN(updateData.quantity) || updateData.quantity < 0)) {
                showNotificationMessage('Please enter a valid quantity', 'danger');
                return;
            }
            
            if (updateData.minStock !== undefined && (isNaN(updateData.minStock) || updateData.minStock < 1)) {
                showNotificationMessage('Minimum stock must be at least 1', 'danger');
                return;
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';
            submitBtn.disabled = true;
            
            try {
                // Use PATCH method for partial update
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.error === 'Duplicate SKU') {
                        throw new Error('This SKU already exists. Please use a different SKU.');
                    }
                    throw new Error(data.message || data.error || 'Failed to update product');
                }
                
                showNotificationMessage('Product updated successfully!', 'success');
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                showNotificationMessage(error.message, 'danger');
                
                // Re-enable button
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Update Product';
                submitBtn.disabled = false;
            }
        });

        // Input validation
        document.getElementById('productPrice').addEventListener('input', function(e) {
            let value = e.target.value;
            if (value.includes('-')) {
                e.target.value = value.replace('-', '');
            }
            calculateProfit();
        });

        document.getElementById('productCost').addEventListener('input', function(e) {
            let value = e.target.value;
            if (value.includes('-')) {
                e.target.value = value.replace('-', '');
            }
            calculateProfit();
        });

        document.getElementById('productQuantity').addEventListener('input', function(e) {
            let value = e.target.value;
            if (value.includes('-')) {
                e.target.value = value.replace('-', '');
            }
            calculateProfit();
        });

        document.getElementById('productMinStock').addEventListener('input', function(e) {
            let value = e.target.value;
            if (value.includes('-')) {
                e.target.value = value.replace('-', '');
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProductData();
        });
    </script>
</body>
</html>
